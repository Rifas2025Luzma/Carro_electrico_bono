(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function s(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(t){if(t.ep)return;t.ep=!0;const e=s(t);fetch(t.href,e)}})();const h={apiKey:"AIzaSyA7irjSjANGeY4iZe80ZuOo_pr3aBhFi5s",authDomain:"rifa-smart-watch.firebaseapp.com",databaseURL:"https://rifa-smart-watch-default-rtdb.firebaseio.com",projectId:"rifa-smart-watch",storageBucket:"rifa-smart-watch.appspot.com",messagingSenderId:"916262944799",appId:"1:916262944799:web:8198492c24022ae398952a",measurementId:"G-YWMZ995XRK"};firebase.initializeApp(h);const l=firebase.database();class f{constructor(){this.participants={},this.DONATION_AMOUNT=5e4,this.initializeApp(),this.setupFirebaseListener(),this.setupImageGallery()}setupImageGallery(){const n=document.querySelectorAll(".hero-image");let s=0;setInterval(()=>{n[s].classList.remove("active"),s=(s+1)%n.length,n[s].classList.add("active")},2e3)}initializeApp(){this.renderProgress(),this.renderParticipantsList(),this.setupEventListeners()}setupFirebaseListener(){l.ref("donations").on("value",n=>{this.participants=n.val()||{},this.renderProgress(),this.renderParticipantsList()})}async updatePaymentStatus(n,s){try{const a={};return n.forEach(t=>{a[`donations/${t}/paymentStatus`]=s}),await l.ref().update(a),!0}catch(a){return console.error("Error actualizando estado de pago:",a),!1}}calculateProgress(){const a=Object.keys(this.participants).length/3e3*100;return{percentage:Math.round(a*10)/10}}calculateTotals(){const n=this.groupParticipantsByPerson();let s=0,a=0;return Object.values(n).forEach(t=>{t.paymentStatus==="nequi"||t.paymentStatus==="other"?s+=this.DONATION_AMOUNT:a+=this.DONATION_AMOUNT}),{totalPaid:s,totalPending:a}}renderProgress(){const n=document.getElementById("progressContainer");if(!n)return;const s=this.calculateProgress();n.innerHTML=`
            <div class="progress-title">Progreso de la Rifa</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${s.percentage}%"></div>
                <div class="progress-text">${s.percentage}% vendido</div>
            </div>
        `}groupParticipantsByPerson(){const n={},s=new Set,a=Object.entries(this.participants).sort((t,e)=>t[1].timestamp-e[1].timestamp);for(let t=0;t<a.length;t++){const[e,r]=a[t];if(s.has(e))continue;const o=`${r.name}-${r.phone}-${r.email}-${r.timestamp}`,i=a[t+1];i&&!s.has(i[0])&&i[1].name===r.name&&i[1].phone===r.phone&&i[1].email===r.email&&i[1].timestamp===r.timestamp?(n[o]={name:r.name,phone:r.phone,email:r.email,numbers:[e,i[0]],paymentStatus:r.paymentStatus,timestamp:r.timestamp},s.add(e),s.add(i[0]),t++):(n[o]={name:r.name,phone:r.phone,email:r.email,numbers:[e],paymentStatus:r.paymentStatus,timestamp:r.timestamp},s.add(e))}return n}renderParticipantsList(){const n=document.getElementById("participantsList");n&&(n.innerHTML=`
            <h2>Números Registrados</h2>
            <div class="sales-summary">
                <p>Números Vendidos: <span class="amount">${Object.keys(this.participants).length}</span></p>
            </div>
            <table class="participants-table">
                <thead>
                    <tr>
                        <th>Números</th>
                        <th>Nombre</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.values(this.groupParticipantsByPerson()).sort((s,a)=>s.timestamp-a.timestamp).map(s=>{const a=s.name.split(" "),t=a[0],e=a[1]?` ${a[1][0]}.`:"",r=t+e;return`
                                <tr>
                                    <td>${s.numbers.sort().join(", ")}</td>
                                    <td>${r}</td>
                                </tr>
                            `}).join("")}
                </tbody>
            </table>
        `)}generateUniqueNumbers(){const n=new Set(Object.keys(this.participants)),s=[];for(;s.length<2;){const a=Math.floor(Math.random()*1e4).toString().padStart(4,"0");n.has(a)||(s.push(a),n.add(a))}return s}generateTicketImage(n,s,a){const t=document.createElement("canvas"),e=t.getContext("2d");return t.width=800,t.height=400,e.fillStyle="#ffffff",e.fillRect(0,0,t.width,t.height),e.strokeStyle="#2ecc71",e.lineWidth=10,e.strokeRect(5,5,t.width-10,t.height-10),e.fillStyle="#2c3e50",e.textAlign="center",e.font="bold 40px Inter",e.fillText("Bono Donación Kiwo",t.width/2,80),e.font="24px Inter",e.fillText(`Nombre: ${n}`,t.width/2,150),e.fillText(`Teléfono: ${s}`,t.width/2,190),e.font="bold 36px Inter",e.fillStyle="#27ae60",e.fillText("Números asignados:",t.width/2,250),e.font="bold 48px Inter",e.fillText(a.join(" - "),t.width/2,310),e.font="20px Inter",e.fillStyle="#2c3e50",e.fillText("Sorteo: Sábado 24 de agosto - Lotería de Boyacá",t.width/2,370),t.toDataURL("image/png")}downloadTicket(n,s){const a=document.createElement("a");a.download=`bono-donacion-${s.toLowerCase().replace(/\s+/g,"-")}.png`,a.href=n,a.click()}async saveParticipant(n,s,a,t){try{const e=Date.now(),r={};return t.forEach(o=>{r[`donations/${o}`]={name:n,phone:s,email:a,timestamp:e,paymentStatus:"pending"}}),await l.ref().update(r),!0}catch(e){return console.error("Error guardando participante:",e),!1}}setupEventListeners(){const n=document.querySelectorAll("#buyButton, .buyButton"),s=document.getElementById("registrationModal"),a=document.getElementById("successModal"),t=document.getElementById("registrationForm");n.forEach(e=>{e.addEventListener("click",()=>{s.classList.add("active")})}),t&&t.addEventListener("submit",async e=>{e.preventDefault();const r=document.getElementById("name").value,o=document.getElementById("phone").value,i=document.getElementById("email").value,c=this.generateUniqueNumbers();if(await this.saveParticipant(r,o,i,c)){s.classList.remove("active");const m=document.getElementById("assignedNumbers");m.innerHTML=c.map(u=>`<span>${u}</span>`).join(""),a.classList.add("active");const p=this.generateTicketImage(r,o,c);this.downloadTicket(p,r),t.reset()}else alert("Error al procesar la donación. Por favor intente nuevamente.")}),window.closeSuccessModal=()=>{a.classList.remove("active")},[s,a].forEach(e=>{e&&e.addEventListener("click",r=>{r.target===e&&e.classList.remove("active")})})}}new f;
